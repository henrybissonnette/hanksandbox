

{% extends "comment_request/comment_base.html" %}

{% block title %}
{{document.title}}
{% endblock title%}

{% block leftside %}
	<div class="l_outer">
		<ul>						
			<li>
			{% for tag in document.get_leaftags %}
			<a href="/tag/{{tag.title}}/" title='{{tag.title}}'>{{tag.title}}</a>
			{% endfor %}
			</li>
		</ul>
	</div>
{% endblock %}

{% block tabs %}
	{% if user.username == document.author.username %}
	<script type="text/javascript">
		tabular('#tab_edit','#edit_tab','maintabs')
		tabular('#tab_view','#document_tab','maintabs',true)
	</script>
	<div class="tabs">
 		<ul class="tabs">
			<li id="tab_view">View</li>
			<li id="tab_edit">Edit</li>
		</ul>

 
	</div>
	{% endif %}
{% endblock %}

{% block main_content %}


	{% comment %}
	---------------------------------------------------------------------------------
	------------------------------------DOCUMENT-------------------------------------
	---------------------------------------------------------------------------------
	{% endcomment %}
<div id="document_tab">
	<h1 class="creator"><a title="Visit {{document.author.username}}'s  Page" class="creator" href="/user/{{document.author.username}}/">
		{{document.author.username}}{% if document.draft %} : draft{% endif %}
		</a></h1>

	
	<h1 class="document" >{{document.title}}</h1>
	
	{% if document.subtitle %}
		<h2 class="document">{{document.subtitle}}</h2>
	{% endif %}
	<div id="document">
	{% autoescape off %}
		{{document.content}}
	{% endautoescape %}
	</div>
	<hr/>
	Tags:<br/>
	{% for tag in document.get_leaftags %}
		<button class="tag">{{tag.title}}</button> 
		{% for ancestor in tag.get_ancestors %}
			< {{ancestor.title}}
		{% endfor %}
		<br/>
	{% endfor %}
	

	{% comment %}
	---------------------------------------------------------------------------------
	------------------------------------DOC INFO-------------------------------------
	{% endcomment %}
	
	<div id="document_info" >
		
	{% comment %}
	------------------------------------FAVORITE-------------------------------------
	{% endcomment %}
	
		{% if user and user.username != document.author.username and not document.key in user.favorites %}

			<script type="text/javascript">
				$(document).ready(function(){			
					$('#favorite').click(function(){	
												
							$.ajax({
								type: "POST",
								url: "/favorite/",
								data: "document=" + "{{document.key}}",
								success: function(){
									$('#favorite_div').ajaxComplete(function(event,request,settings){
										$(this).html('favorite')				
									})
								}
							})				
					})
							
				})	
			</script>
			<div id="favorite_div" class="docinfoitem">
			<button id="favorite" >Favorite</button>
			</div>
			{% endif %}
			{% if user and user.username != document.author.username and document.key in user.favorites %}
			<div class="docinfoitem" id="favorite_div">
			favorite
			</div>
		{% endif %}
		
		{% if not document.draft %}
		
			{% comment %}
			------------------------------------VIEWS-------------------------------------
			{% endcomment %}
			
			<span class="docinfoitem">Views: {{document.views}}</span>
			<br/>
			
			{% comment %}
			------------------------------------RATINGS-------------------------------------
			{% endcomment %}
			

			{% if document.authorname == user.username  or not user %}
				<span class="docinfoitem">Rating: {{document.rating}}</span>
			{% else %}
				
				
					{% if user.username in document.raters %}
					<span class="docinfoitem">Thanks for your feedback. Rating: {{document.rating}}</span>
					{% else %}
							<!-- This script takes rating actions to the server. -->
							<script type="text/javascript">
								$(document).ready(function(){
								  $("a#document_rate_up").click(function(){
								    $("div#rate").load('rate/',{
								    	"rating":"up",
								    	"filename":"{{document.filename}}",
								    	"username":"{{document.author.username}}",
								    	});
								  });
								  $("a#document_rate_down").click(function(){
								    $("div#rate").load('rate/',{
								    	"rating":"down",
								    	"filename":"{{document.filename}}",
								    	"username":"{{document.author.username}}",
								    	});
								  });
								});		
							</script>
							
					<div class="docinfoitem" id="rate">
						<a href="javascript:;" title="Vote Document Up" id="document_rate_up" class="rate_up"></a>
						<a href="javascript:;" title="Vote Document Down" id="document_rate_down" class="rate_down"></a>
					</div>	
					{% endif %}
			{% endif %}
		
			<br/>
			
			{% comment %}
			------------------------------------FACEBOOK-------------------------------------
			{% endcomment %}
					
			<iframe src="http://www.facebook.com/plugins/like.php?href=http://hanksandbox.appspot.com/{{document.author.username}}/document/{{document.filename}}/"
	        scrolling="no" frameborder="0"
	        class="facebook docinfoitem"></iframe>
	        
        {% endif %}
	</div>

</div>	

	{% comment %}
	---------------------------------------------------------------------------------
	------------------------------------EDIT-----------------------------------------
	---------------------------------------------------------------------------------
	{% endcomment %}
	
	{% if user.username == document.author.username %}
	
<div id="edit_tab">
	<script type="text/javascript">
		tabular('#tab_write','#write','edittabs',true)
		tabular('#tab_tag','#tag','edittabs')
	</script>
	<div class="bodytabs">
 		<ul class="tabs">
			<li id="tab_write">Write</li>
			<li id="tab_tag">Tag</li>
		</ul>
	</div>
	
		<script type="text/javascript">
			basic_MCE()
			var forbidden = "`~!@#$%^&*()+={}[]\\|:;\"\'<>,. ";
		
			var works = new Array();
			{% for document in userdocuments %}
			works.push("{{document.filename}}");
			{% endfor %}
		
			var added_tags = new Array();
			{% if document %}
				{% for title in document.leaftags %}
					added_tags.push("'{{title}}'")			 
				{% endfor %}
			{% endif %}		
			
			function validate_filename()
			{
				var x=document.getElementById("filename").value;
				if (x==null || x=="")
				  {
					  alert("Filename is required.");
					  return false;
				  }
				for(i=0;i < forbidden.length;i++)
					{
						if (x.indexOf(forbidden.charAt(i)) != -1)
						{
							alert("Filenames may only contain A-z, 1-9, _ , and -.");
							return false;
						}
					}
				{% if not document %}
				if (array_member(works,x))
					{
						var confirmation = confirm("You have already created a document with this file name. Do you want to replace it?");
						return confirmation;
					}
				{% endif %}
			}

			$(document).ready(function(){
				
				for(var i=0;i<added_tags.length;i++){
					
					var context = [['title',added_tags[i].slice(1,-1)]]
					temp_string = 	'<div class="include_%title%">	\
									<input type="hidden" name="added_tag" class="include_%title%" value="%title%"/>	\
									</div>'
					var final_string = template(temp_string,context);
					$('input#create_input').after(final_string);
				}
			})

		</script>
	
	{% comment %}
	----------------------------------------------------------------------------
	--------------------------------WRITE---------------------------------------
	{% endcomment %}
		<div class="fullpage" id="write">
		<h1 class="embed">Edit</h1>
		<form action="/create"  method=post>
			<table>
				<tr>
					<td>File Name: </td><td><input type="text" id="filename" name="filename" size=40 value="{{document.filename}}" /></td>
				</tr>
				<tr>
					<td>Title: </td><td><input type="text" name="title" size=80 value="{{document.title}}" /></td>
				</tr>
				<tr>
					<td>Subtitle (optional): </td><td><input id="create_input" type="text" name="subtitle" size=80 value="{{document.subtitle}}" /></td>
				</tr>
				<tr>
					<td>Description: </td><td><input type="text" name="description" size=80 value="{{document.get_description}}" 
						title="Used in streams and search results. Use it to attract readers who will be interested in your content. Max 150 characters. No special characters or HTML tags allowed."/></td>
				</tr>
			</table>
			{% for tag in added_tags %}
			<div class="include_{{tag.title}}">
			<input type="hidden" name="added_tag" class="include_{{tag.title}}" value="{{tag.title}}"/>
			</div>
			{% endfor%}
			<input type="hidden" name="username" value="{{document.author.username}}"/>
			<input type="hidden" name="existing_filename" value="{{document.filename}}"/>
		    <textarea name=document_content rows=20 cols=75>{{document.content}}</textarea>
		    <br>
		    <input type="checkbox" name="draft" value="True" {% if document.draft or not document %}checked{% endif %} /> Mark as Draft | 
		    <input type=checkbox name="subscribe" value="subscribe" {% if user.username in document.subscribers or not edit %}checked{%endif%}>
		    	<span>Recieve email notifications if someone replies to this Document.</span>
		    </input>
		    <br/>
		    <input type=submit 
		    value={% if document %}"Save"{% else %}"Create"{% endif %}
		    onClick="return validate_filename()"
		    />
	
	
		</form>
		
		<script type="text/javascript">
		$(document).ready(function(){
			$('#cancel_button').click(function(){
					var agree=confirm('You are about to close this document without saving. Continue?');
					if (agree)
						window.history.back();
				})
			})	
		</script>
		<button id="cancel_button" >Cancel</button>
		
		{% if document %}
		<form action="delete/" method="get">
			<input type="submit" value="Delete" title="Permanently delete this document." onClick="return confirmSubmit('Do you want to permanently delete this document?')"/>
		</form>
		{% endif %}
		</div>
	{% comment %}
	----------------------------------------------------------------------------
	--------------------------------TAG-----------------------------------------
	{% endcomment %}

		<div class="fullpage" id="tag">
			<h2>Current Tags</h2>
			<div id="added_tags">{% include 'tag_request/addto.html' %}</div>
			<div id="tags">
				
					
				<script type="text/javascript">
					divtrigger("button#browse_tags","div#tags",'tag_base/',{"user_type":"user"})
				</script> 	
				<button  title="Use tags to identify your topic" id="browse_tags" class="subtlebutton">Add Tags</button>
			</div>
			
	
		</div>
</div>

	{% endif %}
{% endblock main_content %}