{% extends "comment_request/commentary.html" %}

{% block title %}
{{ page_user.username }}'s Page
{% endblock title%}

{% block sidebar %}

{% if user.username == page_user.username %}
	<script type="text/javascript">
		reveal_controller('h2#circle','#circle_div')
		reveal_controller('h3#mycircle','#mycircle_div')
		reveal_controller('h3#mypermissions','#mypermissions_div')
		reveal_controller('h3#myinvitees','#myinvitees_div')
		reveal_controller('h3#myinvitations','#myinvitations_div')
	</script>
	<h2 id="circle">Writer's Circle</h2>
	<div id="circle_div">
		{% if user.circle %}
		<h3 id="mycircle" title="users who belong to your writers circle">My Writer's Circle</h3>
		<div id="mycircle_div">
			{% for member in user.circle %}
			<a href="/user/{{ member }}/" class="sidebar_link">{{member}}</a>
			{% endfor %}
		</div>
		{% endif %}
		
		{% if user.circlepermissions %}
		<h3 id="mypermissions" title="users whose circles you belong to" >My Circle Permissions</h3>
		<div id="mypermissions_div">
			{% for member in user.circlepermissions %}
			<a href="/user/{{ member }}/" class="sidebar_link">{{member}}</a>
			{% endfor %}
		</div>
		{% endif %}
		
		{% if user.invitees %}
		<h3 id="myinvitees" title="people you've invited to join your writer's circle">Invitees</h3>
		<div id="myinvitees_div">
			{% for invitee in user.invitees %}
			<a href="/user/{{ invitee }}/" class="sidebar_link">{{invitee}}</a>
			{% endfor %}
		</div>
		{% endif %}
	
		{% if user.invitations %}
		<h3 id="myinvitations" title="the following people want you to join their writer's circle">Invitations</h3>
		<div id="myinvitations_div">
			{% for invite in user.invitations %}
				<div id="{{invite}}">
					<script type="text/javascript">
						$(document).ready(function(){
							
								$('#accept{{invite}}').click(function(){	
															
										$.ajax({
											type: "POST",
											url: "/invite_handler/",
											data: "inviter={{invite}}&accept=True",
											success: function(){
												$('#mypermissions_div').ajaxComplete(function(event,request,settings){
													$(this).add(
													'<a href="/user/{{ invite }}/">{{invite}}</a>'
													)													
												})								
												$('#{{invite}}').ajaxComplete(function(event,request,settings){
													$(this).remove()													
												})
											}	
										})											
									})			
								})
								
						$(document).ready(function(){
							
								$('#reject{{invite}}').click(function(){	
															
										$.ajax({
											type: "POST",
											url: "/invite_handler/",
											data: "inviter={{invite}}&accept=False",
											success: function(){							
												$('#{{invite}}').ajaxComplete(function(event,request,settings){
													$(this).remove()													
												})
											}	
										})											
									})			
								})
	
					</script>
					
					<a href="javascript:;" id="accept{{invite}}" class="subtle" title="accept" class="sidebar_link">(+)</a>
						<a href="/user/{{ invite }}/" target='_blank' class="sidebar_link">{{invite}}</a>
					<a href="javascript:;" id="reject{{invite}}" class="subtle" title="reject" class="sidebar_link">(-)</a>
				</div>
			</div>
			{% endfor %}
		{% endif %}
	</div>
{% endif %}

{% if user.username != page_user.username %}
	{% if page_user.username not in user.circle and page_user.username not in user.invitees %}
		<script type="text/javascript">
			$(document).ready(function(){
			
				$('#addtocircle').click(function(){	
											
						$.ajax({
							type: "POST",
							url: "/invite/",
							data: "invitee=" + "{{page_user.username}}",
							success: function(){
								$('#yourcircle').ajaxComplete(function(event,request,settings){
									$(this).html('<span class="rate">{{page_user.username}} has been invited to join your writers circle</span>')				
								})
							}
						})				
				})
						
			})	
		</script>
		
		
		<div id="yourcircle" >
		<a href="javascript:;" id="addtocircle" title="invite {{page_user.username}} to read your drafts" class="sidebar_link">invite to circle</a>
		</div>
	
	{% else %}
	
		{% if page_user.username in user.invitees %}
		<span class="rate">{{page_user.username}} has been invited to join your writers circle</span>
		{% endif %}
		
		{% if page_user.username in user.circle %}
		<span class="rate">{{page_user.username}} is a member of your writers circle</span>
		{% endif %}
		
	{% endif %}
{% endif %}

{% endblock %}

{% block main_content %}



<h1> Welcome to {{ page_user.username }}'s Page </h1>




<h2> {{ page_user.username }}'s Essays </h2>		
{% ifequal page_user.username user.username %}
<a href="/create">Create</a>
{% endifequal %}
	<ul>
	{% for essay in essays %}
	{% if not essay.draft %}
			<li><a href="/{{ page_user.username }}/document/{{ essay.filename }}/">
			{{ essay.title }}</a><br/>
			{% if essay.subtitle %}{{essay.subtitle}}{% endif %} 
			{% if essay.draft %}draft!{% endif %}
			</li>
	{% endif %}
	{% endfor %}
	</ul>

{% if user.username in page_user.cirlce or page_user.username == user.username %}
<h2> {{ page_user.username }}'s Drafts </h2>	

	<ul>
	{% for draft in essays %}
	{% if draft.draft %}
		<li><a href="/{{ page_user }}/document/{{ essay.filename }}/">
			{{ draft.title }}</a><br/>
			{% if draft.subtitle %}{{essay.subtitle}}{% endif %} 
			</li>
	{% endif %}
	{% endfor %}
	</ul>

{% endif %}

{% endblock main_content %}

